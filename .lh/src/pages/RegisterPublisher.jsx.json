{
    "sourceFile": "src/pages/RegisterPublisher.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766942540489,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766944075806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,35 +1,40 @@\n-import { useEffect, useState } from \"react\";\n-import { useNavigate } from \"react-router-dom\";\n-import { toast } from \"react-toastify\";\n+import { useEffect, useRef, useState } from \"react\";\n+import { toast, ToastContainer } from \"react-toastify\";\n+import { useNavigate, Link } from \"react-router-dom\";\n import api from \"../api/client\";\n \n export default function RegisterPublisher() {\n   const navigate = useNavigate();\n \n   const [loadingTypes, setLoadingTypes] = useState(true);\n-  const [publisherTypes, setPublisherTypes] = useState([]); // dynamic from admin\n+  const [publisherTypes, setPublisherTypes] = useState([]);\n+\n+  const [step, setStep] = useState(\"form\"); // form | otp\n   const [submitting, setSubmitting] = useState(false);\n+  const [verifying, setVerifying] = useState(false);\n \n   const [form, setForm] = useState({\n-    publisherType: \"\",         // dynamic (id)\n+    publisherType: \"\",\n     organizationName: \"\",\n-    organizationType: \"\",      // tech/civil/automotive etc\n+    organizationType: \"\",\n     publisherName: \"\",\n     email: \"\",\n   });\n \n-  const setVal = (key, val) => setForm((p) => ({ ...p, [key]: val }));\n+  // OTP\n+  const [otp, setOtp] = useState([\"\", \"\", \"\", \"\", \"\", \"\"]);\n+  const inputRefs = useRef([]);\n \n-  // load publisher types from backend (dynamic)\n+  const setVal = (k, v) => setForm((p) => ({ ...p, [k]: v }));\n+\n   useEffect(() => {\n     (async () => {\n       try {\n         setLoadingTypes(true);\n-        // backend should return { types: [{_id, name}] }\n         const res = await api.get(\"/api/public/publisher-types\");\n         setPublisherTypes(res.data?.types || []);\n-      } catch (err) {\n+      } catch (e) {\n         toast.error(\"Failed to load publisher types\");\n       } finally {\n         setLoadingTypes(false);\n       }\n@@ -38,129 +43,209 @@\n \n   const validate = () => {\n     if (!form.publisherType) return \"Select publisher type\";\n     if (!form.organizationName.trim()) return \"Enter organization name\";\n-    if (!form.organizationType.trim()) return \"Enter organization type (tech, civil, etc.)\";\n+    if (!form.organizationType.trim()) return \"Enter organization type (tech/civil/automotive etc.)\";\n     if (!form.publisherName.trim()) return \"Enter publisher name\";\n     if (!form.email.trim()) return \"Enter email\";\n     if (!/^\\S+@\\S+\\.\\S+$/.test(form.email.trim())) return \"Enter a valid email\";\n     return null;\n   };\n \n-  const submit = async (e) => {\n-    e.preventDefault();\n-\n+  const sendOtpAfterRegister = async () => {\n     const msg = validate();\n     if (msg) return toast.error(msg);\n \n     try {\n       setSubmitting(true);\n \n-      // 1) create publisher onboarding (server should create user/publisher draft if not exist)\n-      // expected backend: POST /api/auth/publisher/register\n-      // returns: { message, next: \"otp\", email }\n+      // register + send otp\n       await api.post(\"/api/auth/publisher/register\", {\n         publisherType: form.publisherType,\n         organizationName: form.organizationName,\n         organizationType: form.organizationType,\n         publisherName: form.publisherName,\n         email: form.email,\n       });\n \n-      toast.success(\"Registration saved. OTP sent to email.\");\n+      toast.success(\"OTP sent to your email\");\n+      setStep(\"otp\");\n \n-      // 2) redirect to login (or otp verify page)\n-      navigate(\"/\", { replace: true, state: { prefillEmail: form.email } });\n+      // focus first otp box\n+      setTimeout(() => inputRefs.current?.[0]?.focus(), 200);\n     } catch (err) {\n       toast.error(err?.response?.data?.message || \"Registration failed\");\n     } finally {\n       setSubmitting(false);\n     }\n   };\n \n+  const handleOtpChange = (val, index) => {\n+    if (!/^\\d?$/.test(val)) return; // only digits 0-9\n+    const next = [...otp];\n+    next[index] = val;\n+    setOtp(next);\n+\n+    if (val && index < 5) inputRefs.current[index + 1]?.focus();\n+  };\n+\n+  const handleOtpKeyDown = (e, index) => {\n+    if (e.key === \"Backspace\" && !otp[index] && index > 0) {\n+      inputRefs.current[index - 1]?.focus();\n+    }\n+  };\n+\n+  const verifyOtp = async () => {\n+    const code = otp.join(\"\");\n+    if (code.length !== 6) return toast.error(\"Enter complete 6-digit OTP\");\n+\n+    try {\n+      setVerifying(true);\n+\n+      // backend verifies otp + activates account\n+      // should return token + user role\n+      const res = await api.post(\"/api/auth/verify-otp\", {\n+        email: form.email,\n+        otp: code,\n+        context: \"publisher_register\",\n+      });\n+\n+      const token = res.data?.token;\n+      const role = res.data?.role; // \"publisher\"\n+\n+      if (token) localStorage.setItem(\"token\", token);\n+\n+      toast.success(\"OTP verified. Account created.\");\n+\n+      // redirect based on role\n+      if (role === \"publisher\") navigate(\"/dashboard/publisher\");\n+      else navigate(\"/dashboard/user\");\n+    } catch (err) {\n+      toast.error(err?.response?.data?.message || \"OTP verification failed\");\n+    } finally {\n+      setVerifying(false);\n+    }\n+  };\n+\n+  const resendOtp = async () => {\n+    try {\n+      await api.post(\"/api/auth/resend-otp\", {\n+        email: form.email,\n+        context: \"publisher_register\",\n+      });\n+      toast.success(\"OTP resent\");\n+    } catch (err) {\n+      toast.error(err?.response?.data?.message || \"Resend failed\");\n+    }\n+  };\n+\n   return (\n-    <div className=\"d-flex align-items-center justify-content-center\" style={{ minHeight: \"100vh\", padding: 16 }}>\n-      <div className=\"card shadow-sm\" style={{ width: \"520px\", borderRadius: 14 }}>\n-        <div className=\"card-body p-4\">\n-          <h3 className=\"text-center fw-bold mb-1\">Publisher Registration</h3>\n-          <div className=\"text-center text-muted mb-4\">\n-            Create publisher account to post listings & apply programs\n-          </div>\n+    <div className=\"container d-flex justify-content-center align-items-center\" style={{ minHeight: \"100vh\" }}>\n+      <div className=\"card shadow p-4\" style={{ width: \"520px\", borderRadius: 14 }}>\n+        <h4 className=\"text-center mb-1\">Publisher Registration</h4>\n+        <div className=\"text-center text-muted mb-4\">Create account and verify email with OTP</div>\n \n-          <form onSubmit={submit}>\n-            <div className=\"mb-3\">\n-              <label className=\"form-label\">Publisher Type</label>\n-              <select\n-                className=\"form-select\"\n-                value={form.publisherType}\n-                onChange={(e) => setVal(\"publisherType\", e.target.value)}\n-                disabled={loadingTypes}\n-              >\n-                <option value=\"\">{loadingTypes ? \"Loading...\" : \"Select type\"}</option>\n-                {publisherTypes.map((t) => (\n-                  <option key={t._id} value={t._id}>\n-                    {t.name}\n-                  </option>\n-                ))}\n-              </select>\n-              <div className=\"form-text\">Admin can add new types anytime (dynamic).</div>\n-            </div>\n+        {step === \"form\" ? (\n+          <>\n+            <label className=\"form-label\">Publisher Type</label>\n+            <select\n+              className=\"form-select mb-3\"\n+              value={form.publisherType}\n+              onChange={(e) => setVal(\"publisherType\", e.target.value)}\n+              disabled={loadingTypes}\n+            >\n+              <option value=\"\">{loadingTypes ? \"Loading...\" : \"Select type\"}</option>\n+              {publisherTypes.map((t) => (\n+                <option key={t._id} value={t._id}>\n+                  {t.name}\n+                </option>\n+              ))}\n+            </select>\n \n-            <div className=\"mb-3\">\n-              <label className=\"form-label\">Organization Name</label>\n-              <input\n-                className=\"form-control\"\n-                placeholder=\"e.g. ABC Pvt Ltd / Govt Dept / Startup Name\"\n-                value={form.organizationName}\n-                onChange={(e) => setVal(\"organizationName\", e.target.value)}\n-              />\n-            </div>\n+            <label className=\"form-label\">Organization Name</label>\n+            <input\n+              className=\"form-control mb-3\"\n+              placeholder=\"ABC Pvt Ltd / Govt Dept / Startup name\"\n+              value={form.organizationName}\n+              onChange={(e) => setVal(\"organizationName\", e.target.value)}\n+            />\n \n-            <div className=\"mb-3\">\n-              <label className=\"form-label\">Organization Type</label>\n-              <input\n-                className=\"form-control\"\n-                placeholder=\"e.g. Tech, Civil, Automotive, Education...\"\n-                value={form.organizationType}\n-                onChange={(e) => setVal(\"organizationType\", e.target.value)}\n-              />\n-            </div>\n+            <label className=\"form-label\">Organization Type</label>\n+            <input\n+              className=\"form-control mb-3\"\n+              placeholder=\"Tech / Civil / Automotive / Education...\"\n+              value={form.organizationType}\n+              onChange={(e) => setVal(\"organizationType\", e.target.value)}\n+            />\n \n-            <div className=\"mb-3\">\n-              <label className=\"form-label\">Publisher Name</label>\n-              <input\n-                className=\"form-control\"\n-                placeholder=\"Your full name\"\n-                value={form.publisherName}\n-                onChange={(e) => setVal(\"publisherName\", e.target.value)}\n-              />\n+            <label className=\"form-label\">Publisher Name</label>\n+            <input\n+              className=\"form-control mb-3\"\n+              placeholder=\"Your full name\"\n+              value={form.publisherName}\n+              onChange={(e) => setVal(\"publisherName\", e.target.value)}\n+            />\n+\n+            <label className=\"form-label\">Email Address (OTP will be sent)</label>\n+            <input\n+              type=\"email\"\n+              className=\"form-control mb-3\"\n+              placeholder=\"name@company.com\"\n+              value={form.email}\n+              onChange={(e) => setVal(\"email\", e.target.value)}\n+            />\n+\n+            <button className=\"btn btn-success w-100\" onClick={sendOtpAfterRegister} disabled={submitting}>\n+              {submitting ? \"Sending...\" : \"Register & Send OTP\"}\n+            </button>\n+\n+            <div className=\"text-center mt-3\">\n+              <span className=\"text-muted\">Already have an account?</span>{\" \"}\n+              <Link to=\"/\" className=\"fw-semibold text-decoration-none\">\n+                Login\n+              </Link>\n             </div>\n+          </>\n+        ) : (\n+          <>\n+            <div className=\"alert alert-light border\">\n+              OTP sent to <b>{form.email}</b>\n+            </div>\n \n-            <div className=\"mb-3\">\n-              <label className=\"form-label\">Email (OTP will be sent)</label>\n-              <input\n-                className=\"form-control\"\n-                placeholder=\"name@company.com\"\n-                value={form.email}\n-                onChange={(e) => setVal(\"email\", e.target.value)}\n-              />\n+            <label className=\"form-label\">Enter OTP</label>\n+            <div className=\"d-flex justify-content-between mb-2\">\n+              {[0, 1, 2, 3, 4, 5].map((i) => (\n+                <input\n+                  key={i}\n+                  type=\"text\"\n+                  maxLength=\"1\"\n+                  className=\"form-control text-center mx-1\"\n+                  style={{ width: \"55px\", fontSize: \"22px\" }}\n+                  value={otp[i]}\n+                  onChange={(e) => handleOtpChange(e.target.value, i)}\n+                  onKeyDown={(e) => handleOtpKeyDown(e, i)}\n+                  ref={(el) => (inputRefs.current[i] = el)}\n+                />\n+              ))}\n             </div>\n \n-            <button className=\"btn btn-success w-100\" disabled={submitting}>\n-              {submitting ? \"Creating...\" : \"Register & Send OTP\"}\n+            <button className=\"btn btn-primary w-100 mt-2\" onClick={verifyOtp} disabled={verifying}>\n+              {verifying ? \"Verifying...\" : \"Verify OTP\"}\n             </button>\n \n-            <div className=\"text-center mt-3\">\n-              <button\n-                type=\"button\"\n-                className=\"btn btn-link text-decoration-none\"\n-                onClick={() => navigate(\"/\")}\n-              >\n-                Back to Login\n+            <div className=\"d-flex justify-content-between mt-3\">\n+              <button className=\"btn btn-link p-0 text-decoration-none\" onClick={() => setStep(\"form\")}>\n+                ‚Üê Edit Details\n               </button>\n+\n+              <button className=\"btn btn-link p-0 text-decoration-none\" onClick={resendOtp}>\n+                Resend OTP\n+              </button>\n             </div>\n-          </form>\n-        </div>\n+          </>\n+        )}\n       </div>\n+\n+      <ToastContainer position=\"top-center\" />\n     </div>\n   );\n }\n"
                }
            ],
            "date": 1766942540489,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { toast } from \"react-toastify\";\nimport api from \"../api/client\";\n\nexport default function RegisterPublisher() {\n  const navigate = useNavigate();\n\n  const [loadingTypes, setLoadingTypes] = useState(true);\n  const [publisherTypes, setPublisherTypes] = useState([]); // dynamic from admin\n  const [submitting, setSubmitting] = useState(false);\n\n  const [form, setForm] = useState({\n    publisherType: \"\",         // dynamic (id)\n    organizationName: \"\",\n    organizationType: \"\",      // tech/civil/automotive etc\n    publisherName: \"\",\n    email: \"\",\n  });\n\n  const setVal = (key, val) => setForm((p) => ({ ...p, [key]: val }));\n\n  // load publisher types from backend (dynamic)\n  useEffect(() => {\n    (async () => {\n      try {\n        setLoadingTypes(true);\n        // backend should return { types: [{_id, name}] }\n        const res = await api.get(\"/api/public/publisher-types\");\n        setPublisherTypes(res.data?.types || []);\n      } catch (err) {\n        toast.error(\"Failed to load publisher types\");\n      } finally {\n        setLoadingTypes(false);\n      }\n    })();\n  }, []);\n\n  const validate = () => {\n    if (!form.publisherType) return \"Select publisher type\";\n    if (!form.organizationName.trim()) return \"Enter organization name\";\n    if (!form.organizationType.trim()) return \"Enter organization type (tech, civil, etc.)\";\n    if (!form.publisherName.trim()) return \"Enter publisher name\";\n    if (!form.email.trim()) return \"Enter email\";\n    if (!/^\\S+@\\S+\\.\\S+$/.test(form.email.trim())) return \"Enter a valid email\";\n    return null;\n  };\n\n  const submit = async (e) => {\n    e.preventDefault();\n\n    const msg = validate();\n    if (msg) return toast.error(msg);\n\n    try {\n      setSubmitting(true);\n\n      // 1) create publisher onboarding (server should create user/publisher draft if not exist)\n      // expected backend: POST /api/auth/publisher/register\n      // returns: { message, next: \"otp\", email }\n      await api.post(\"/api/auth/publisher/register\", {\n        publisherType: form.publisherType,\n        organizationName: form.organizationName,\n        organizationType: form.organizationType,\n        publisherName: form.publisherName,\n        email: form.email,\n      });\n\n      toast.success(\"Registration saved. OTP sent to email.\");\n\n      // 2) redirect to login (or otp verify page)\n      navigate(\"/\", { replace: true, state: { prefillEmail: form.email } });\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Registration failed\");\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"d-flex align-items-center justify-content-center\" style={{ minHeight: \"100vh\", padding: 16 }}>\n      <div className=\"card shadow-sm\" style={{ width: \"520px\", borderRadius: 14 }}>\n        <div className=\"card-body p-4\">\n          <h3 className=\"text-center fw-bold mb-1\">Publisher Registration</h3>\n          <div className=\"text-center text-muted mb-4\">\n            Create publisher account to post listings & apply programs\n          </div>\n\n          <form onSubmit={submit}>\n            <div className=\"mb-3\">\n              <label className=\"form-label\">Publisher Type</label>\n              <select\n                className=\"form-select\"\n                value={form.publisherType}\n                onChange={(e) => setVal(\"publisherType\", e.target.value)}\n                disabled={loadingTypes}\n              >\n                <option value=\"\">{loadingTypes ? \"Loading...\" : \"Select type\"}</option>\n                {publisherTypes.map((t) => (\n                  <option key={t._id} value={t._id}>\n                    {t.name}\n                  </option>\n                ))}\n              </select>\n              <div className=\"form-text\">Admin can add new types anytime (dynamic).</div>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\">Organization Name</label>\n              <input\n                className=\"form-control\"\n                placeholder=\"e.g. ABC Pvt Ltd / Govt Dept / Startup Name\"\n                value={form.organizationName}\n                onChange={(e) => setVal(\"organizationName\", e.target.value)}\n              />\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\">Organization Type</label>\n              <input\n                className=\"form-control\"\n                placeholder=\"e.g. Tech, Civil, Automotive, Education...\"\n                value={form.organizationType}\n                onChange={(e) => setVal(\"organizationType\", e.target.value)}\n              />\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\">Publisher Name</label>\n              <input\n                className=\"form-control\"\n                placeholder=\"Your full name\"\n                value={form.publisherName}\n                onChange={(e) => setVal(\"publisherName\", e.target.value)}\n              />\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\">Email (OTP will be sent)</label>\n              <input\n                className=\"form-control\"\n                placeholder=\"name@company.com\"\n                value={form.email}\n                onChange={(e) => setVal(\"email\", e.target.value)}\n              />\n            </div>\n\n            <button className=\"btn btn-success w-100\" disabled={submitting}>\n              {submitting ? \"Creating...\" : \"Register & Send OTP\"}\n            </button>\n\n            <div className=\"text-center mt-3\">\n              <button\n                type=\"button\"\n                className=\"btn btn-link text-decoration-none\"\n                onClick={() => navigate(\"/\")}\n              >\n                Back to Login\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n}\n"
        }
    ]
}