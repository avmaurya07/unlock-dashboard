{
    "sourceFile": "src/pages/admin/Publishers.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1766940831906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1766940831906,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from \"react\";\nimport { toast } from \"react-toastify\";\n\nimport Pagination from \"../../components/Pagination\";\nimport ExtendSubscriptionModal from \"../../components/ExtendSubscriptionModal\";\n\nimport {\n  getAdminPublishers,\n  setPublisherSuspended,\n  extendPublisherSubscription,\n  setPublisherServicePlan,\n} from \"../../api/adminPublishers\";\n\nexport default function Publishers() {\n  const [loading, setLoading] = useState(true);\n  const [rows, setRows] = useState([]);\n  const [meta, setMeta] = useState({ page: 1, totalPages: 1, total: 0, limit: 20 });\n\n  // filters\n  const [q, setQ] = useState(\"\");\n  const [status, setStatus] = useState(\"all\"); // all | active | expired | suspended\n  const [page, setPage] = useState(1);\n  const [limit, setLimit] = useState(20);\n\n  // modal\n  const [modalOpen, setModalOpen] = useState(false);\n  const [selected, setSelected] = useState(null);\n  const [actionLoading, setActionLoading] = useState(false);\n\n  const load = async () => {\n    try {\n      setLoading(true);\n      const res = await getAdminPublishers({\n        q: q || undefined,\n        status: status === \"all\" ? undefined : status,\n        page,\n        limit,\n      });\n\n      setRows(res.data?.publishers || []);\n      setMeta(res.data?.meta || { page, totalPages: 1, total: 0, limit });\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to load publishers\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    load();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [page, limit, status]);\n\n  const applyFilters = () => {\n    setPage(1);\n    load();\n  };\n\n  const resetFilters = () => {\n    setQ(\"\");\n    setStatus(\"all\");\n    setPage(1);\n    setLimit(20);\n    setTimeout(load, 0);\n  };\n\n  const openExtend = (publisher) => {\n    setSelected(publisher);\n    setModalOpen(true);\n  };\n\n  const onExtendSubmit = async (payload) => {\n    if (!selected?._id) return;\n\n    try {\n      setActionLoading(true);\n      await extendPublisherSubscription(selected._id, payload);\n      toast.success(\"Subscription updated\");\n      setModalOpen(false);\n      await load();\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to update subscription\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const toggleSuspend = async (publisher) => {\n    try {\n      setActionLoading(true);\n      const suspend = publisher.subscriptionStatus !== \"suspended\";\n      await setPublisherSuspended(publisher._id, suspend);\n      toast.success(suspend ? \"Publisher suspended\" : \"Publisher unsuspended\");\n      await load();\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to update status\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const toggleServicePlan = async (publisher) => {\n    try {\n      setActionLoading(true);\n      await setPublisherServicePlan(publisher._id, !publisher.servicePlanActive);\n      toast.success(\"Service plan updated\");\n      await load();\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to update service plan\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const badge = (subStatus) => {\n    if (subStatus === \"active\") return \"bg-success\";\n    if (subStatus === \"expired\") return \"bg-secondary\";\n    if (subStatus === \"suspended\") return \"bg-danger\";\n    return \"bg-secondary\";\n  };\n\n  return (\n    <div className=\"p-2 p-md-3\">\n      <div className=\"d-flex align-items-center justify-content-between mb-3\">\n        <div>\n          <h3 className=\"fw-bold mb-1\">Publishers</h3>\n          <div className=\"text-muted small\">Manage publisher accounts, subscriptions, and service plan</div>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"bg-white rounded-4 shadow-sm p-3 mb-3\">\n        <div className=\"row g-2 align-items-end\">\n          <div className=\"col-12 col-md-6\">\n            <label className=\"form-label small text-muted\">Search</label>\n            <input\n              className=\"form-control\"\n              placeholder=\"Search company name / email…\"\n              value={q}\n              onChange={(e) => setQ(e.target.value)}\n            />\n          </div>\n\n          <div className=\"col-6 col-md-3\">\n            <label className=\"form-label small text-muted\">Status</label>\n            <select className=\"form-select\" value={status} onChange={(e) => setStatus(e.target.value)}>\n              <option value=\"all\">All</option>\n              <option value=\"active\">Active</option>\n              <option value=\"expired\">Expired</option>\n              <option value=\"suspended\">Suspended</option>\n            </select>\n          </div>\n\n          <div className=\"col-6 col-md-3\">\n            <label className=\"form-label small text-muted\">Per page</label>\n            <select className=\"form-select\" value={limit} onChange={(e) => setLimit(Number(e.target.value))}>\n              <option value={10}>10</option>\n              <option value={20}>20</option>\n              <option value={50}>50</option>\n            </select>\n          </div>\n\n          <div className=\"col-12 d-flex gap-2 justify-content-end\">\n            <button className=\"btn btn-light border\" onClick={resetFilters}>Reset</button>\n            <button className=\"btn btn-success\" onClick={applyFilters}>\n              <i className=\"bi bi-search me-1\" /> Apply\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Table */}\n      <div className=\"bg-white rounded-4 shadow-sm p-0 overflow-hidden\">\n        <div className=\"d-flex justify-content-between align-items-center p-3 border-bottom\">\n          <div className=\"fw-bold\">Results</div>\n          <div className=\"text-muted small\">\n            Total: <span className=\"fw-semibold\">{meta.total || 0}</span>\n          </div>\n        </div>\n\n        <div className=\"table-responsive\">\n          <table className=\"table align-middle mb-0\">\n            <thead className=\"table-light\">\n              <tr>\n                <th style={{ minWidth: 220 }}>Publisher</th>\n                <th style={{ minWidth: 180 }}>Type</th>\n                <th style={{ minWidth: 120 }}>Status</th>\n                <th style={{ minWidth: 140 }}>Expiry</th>\n                <th style={{ minWidth: 160 }}>Service Plan</th>\n                <th className=\"text-end\" style={{ minWidth: 320 }}>Actions</th>\n              </tr>\n            </thead>\n\n            <tbody>\n              {loading ? (\n                <tr><td colSpan={6} className=\"p-4 text-muted\">Loading…</td></tr>\n              ) : rows.length === 0 ? (\n                <tr><td colSpan={6} className=\"p-4 text-muted\">No publishers found.</td></tr>\n              ) : (\n                rows.map((p) => (\n                  <tr key={p._id}>\n                    <td>\n                      <div className=\"fw-semibold\">{p.companyName || \"—\"}</div>\n                      <div className=\"text-muted small\">{p?.userId?.email || \"—\"}</div>\n                    </td>\n\n                    <td>\n                      <span className=\"badge bg-secondary\">\n                        {p?.publisherType?.name || p?.publisherType || \"—\"}\n                      </span>\n                    </td>\n\n                    <td>\n                      <span className={`badge ${badge(p.subscriptionStatus)}`}>\n                        {p.subscriptionStatus || \"—\"}\n                      </span>\n                    </td>\n\n                    <td className=\"text-muted small\">\n                      {p.subscriptionExpiry ? new Date(p.subscriptionExpiry).toLocaleDateString() : \"—\"}\n                    </td>\n\n                    <td>\n                      <span className={`badge ${p.servicePlanActive ? \"bg-success\" : \"bg-light text-dark border\"}`}>\n                        {p.servicePlanActive ? \"Active\" : \"Inactive\"}\n                      </span>\n                    </td>\n\n                    <td className=\"text-end\">\n                      <div className=\"d-flex gap-2 justify-content-end\">\n                        <button\n                          className=\"btn btn-outline-secondary btn-sm\"\n                          onClick={() => openExtend(p)}\n                          disabled={actionLoading}\n                        >\n                          Extend\n                        </button>\n\n                        <button\n                          className={`btn btn-sm ${p.subscriptionStatus === \"suspended\" ? \"btn-outline-danger\" : \"btn-danger\"}`}\n                          onClick={() => {\n                            const msg = p.subscriptionStatus === \"suspended\"\n                              ? \"Unsuspend this publisher?\"\n                              : \"Suspend this publisher?\";\n                            if (!window.confirm(msg)) return;\n                            toggleSuspend(p);\n                          }}\n                          disabled={actionLoading}\n                        >\n                          {p.subscriptionStatus === \"suspended\" ? \"Unsuspend\" : \"Suspend\"}\n                        </button>\n\n                        <button\n                          className={`btn btn-sm ${p.servicePlanActive ? \"btn-outline-success\" : \"btn-success\"}`}\n                          onClick={() => {\n                            const msg = p.servicePlanActive\n                              ? \"Disable service plan?\"\n                              : \"Enable service plan?\";\n                            if (!window.confirm(msg)) return;\n                            toggleServicePlan(p);\n                          }}\n                          disabled={actionLoading}\n                        >\n                          {p.servicePlanActive ? \"Service OFF\" : \"Service ON\"}\n                        </button>\n                      </div>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n\n        <div className=\"p-3 border-top\">\n          <Pagination\n            page={meta.page || page}\n            totalPages={meta.totalPages || 1}\n            onPage={(p) => setPage(p)}\n          />\n        </div>\n      </div>\n\n      <ExtendSubscriptionModal\n        open={modalOpen}\n        onClose={() => setModalOpen(false)}\n        publisher={selected}\n        actionLoading={actionLoading}\n        onSubmit={onExtendSubmit}\n      />\n    </div>\n  );\n}\n"
        }
    ]
}