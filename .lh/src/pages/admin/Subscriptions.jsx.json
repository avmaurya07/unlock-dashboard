{
    "sourceFile": "src/pages/admin/Subscriptions.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1766941370949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1766941370949,
            "name": "Commit-0",
            "content": "import { useEffect, useState } from \"react\";\nimport { toast } from \"react-toastify\";\nimport {\n  getSubscriptionConfig,\n  updateSubscriptionConfig,\n} from \"../../api/adminSubscriptions\";\n\nexport default function Subscriptions() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n\n  const [currency, setCurrency] = useState(\"INR\");\n\n  const [plan3, setPlan3] = useState(\"\");\n  const [plan6, setPlan6] = useState(\"\");\n  const [plan9, setPlan9] = useState(\"\");\n\n  const [yearlyFee, setYearlyFee] = useState(\"\");\n\n  // keep original for Reset\n  const [original, setOriginal] = useState(null);\n\n  const load = async () => {\n    try {\n      setLoading(true);\n      const res = await getSubscriptionConfig();\n\n      const cfg = res.data?.config || {};\n      const plans = cfg.plans || {};\n\n      const next = {\n        currency: cfg.currency || \"INR\",\n        plan3: plans[\"3\"] ?? plans[3] ?? \"\",\n        plan6: plans[\"6\"] ?? plans[6] ?? \"\",\n        plan9: plans[\"9\"] ?? plans[9] ?? \"\",\n        yearlyFee: cfg.serviceListingYearlyFee ?? \"\",\n      };\n\n      setCurrency(next.currency);\n      setPlan3(String(next.plan3));\n      setPlan6(String(next.plan6));\n      setPlan9(String(next.plan9));\n      setYearlyFee(String(next.yearlyFee));\n\n      setOriginal(next);\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to load subscription config\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    load();\n  }, []);\n\n  const validateNumber = (value, label) => {\n    const n = Number(value);\n    if (!Number.isFinite(n) || n < 0) {\n      toast.error(`${label} must be a valid number (>= 0)`);\n      return null;\n    }\n    // razorpay amount etc should be integer in UI\n    return Math.round(n);\n  };\n\n  const onSave = async () => {\n    const p3 = validateNumber(plan3, \"3-month price\");\n    const p6 = validateNumber(plan6, \"6-month price\");\n    const p9 = validateNumber(plan9, \"9-month price\");\n    const yf = validateNumber(yearlyFee, \"Yearly service listing fee\");\n\n    if (p3 === null || p6 === null || p9 === null || yf === null) return;\n\n    // brutal truth: prevent nonsense pricing\n    if (p6 < p3) return toast.error(\"6-month price should be >= 3-month price\");\n    if (p9 < p6) return toast.error(\"9-month price should be >= 6-month price\");\n\n    try {\n      setSaving(true);\n\n      const payload = {\n        currency,\n        plans: { 3: p3, 6: p6, 9: p9 },\n        serviceListingYearlyFee: yf,\n      };\n\n      await updateSubscriptionConfig(payload);\n\n      toast.success(\"Pricing updated\");\n      setOriginal({\n        currency,\n        plan3: String(p3),\n        plan6: String(p6),\n        plan9: String(p9),\n        yearlyFee: String(yf),\n      });\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to update pricing\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const onReset = () => {\n    if (!original) return;\n    setCurrency(original.currency);\n    setPlan3(String(original.plan3));\n    setPlan6(String(original.plan6));\n    setPlan9(String(original.plan9));\n    setYearlyFee(String(original.yearlyFee));\n    toast.info(\"Reset to saved values\");\n  };\n\n  const changed =\n    original &&\n    (currency !== original.currency ||\n      String(plan3) !== String(original.plan3) ||\n      String(plan6) !== String(original.plan6) ||\n      String(plan9) !== String(original.plan9) ||\n      String(yearlyFee) !== String(original.yearlyFee));\n\n  return (\n    <div className=\"p-2 p-md-3\">\n      <div className=\"d-flex align-items-center justify-content-between mb-3\">\n        <div>\n          <h3 className=\"fw-bold mb-1\">Subscriptions</h3>\n          <div className=\"text-muted small\">\n            Manage plan pricing (3/6/9 months) and yearly service listing fee\n          </div>\n        </div>\n\n        <div className=\"d-flex gap-2\">\n          <button\n            className=\"btn btn-light border\"\n            onClick={onReset}\n            disabled={!changed || loading || saving}\n          >\n            Reset\n          </button>\n          <button\n            className=\"btn btn-success\"\n            onClick={onSave}\n            disabled={loading || saving || !changed}\n          >\n            {saving ? \"Saving…\" : \"Save Changes\"}\n          </button>\n        </div>\n      </div>\n\n      {loading ? (\n        <div className=\"bg-white rounded-4 shadow-sm p-4 text-muted\">Loading…</div>\n      ) : (\n        <div className=\"row g-3\">\n          {/* Plan pricing */}\n          <div className=\"col-12 col-lg-7\">\n            <div className=\"bg-white rounded-4 shadow-sm p-3\">\n              <div className=\"d-flex align-items-center justify-content-between mb-3\">\n                <div className=\"fw-bold\">Plan Pricing</div>\n                <div className=\"d-flex align-items-center gap-2\">\n                  <span className=\"text-muted small\">Currency</span>\n                  <select\n                    className=\"form-select form-select-sm\"\n                    style={{ width: 110 }}\n                    value={currency}\n                    onChange={(e) => setCurrency(e.target.value)}\n                  >\n                    <option value=\"INR\">INR</option>\n                    <option value=\"THB\">THB</option>\n                    <option value=\"USD\">USD</option>\n                  </select>\n                </div>\n              </div>\n\n              <div className=\"row g-3\">\n                <div className=\"col-12 col-md-4\">\n                  <label className=\"form-label small text-muted\">3 Months Price</label>\n                  <div className=\"input-group\">\n                    <span className=\"input-group-text\">{currency}</span>\n                    <input\n                      type=\"number\"\n                      min=\"0\"\n                      className=\"form-control\"\n                      value={plan3}\n                      onChange={(e) => setPlan3(e.target.value)}\n                      placeholder=\"e.g. 999\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"col-12 col-md-4\">\n                  <label className=\"form-label small text-muted\">6 Months Price</label>\n                  <div className=\"input-group\">\n                    <span className=\"input-group-text\">{currency}</span>\n                    <input\n                      type=\"number\"\n                      min=\"0\"\n                      className=\"form-control\"\n                      value={plan6}\n                      onChange={(e) => setPlan6(e.target.value)}\n                      placeholder=\"e.g. 1799\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"col-12 col-md-4\">\n                  <label className=\"form-label small text-muted\">9 Months Price</label>\n                  <div className=\"input-group\">\n                    <span className=\"input-group-text\">{currency}</span>\n                    <input\n                      type=\"number\"\n                      min=\"0\"\n                      className=\"form-control\"\n                      value={plan9}\n                      onChange={(e) => setPlan9(e.target.value)}\n                      placeholder=\"e.g. 2499\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"col-12\">\n                  <div className=\"alert alert-info mb-0\">\n                    <div className=\"fw-semibold\">Rule (recommended)</div>\n                    <div className=\"small\">\n                      Keep 6-month ≥ 3-month and 9-month ≥ 6-month.\n                      Otherwise users will pick the cheaper longer plan.\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Yearly fee */}\n          <div className=\"col-12 col-lg-5\">\n            <div className=\"bg-white rounded-4 shadow-sm p-3\">\n              <div className=\"fw-bold mb-3\">Yearly Service Listing Fee</div>\n\n              <label className=\"form-label small text-muted\">\n                Service listing add-on (per year)\n              </label>\n              <div className=\"input-group mb-3\">\n                <span className=\"input-group-text\">{currency}</span>\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  className=\"form-control\"\n                  value={yearlyFee}\n                  onChange={(e) => setYearlyFee(e.target.value)}\n                  placeholder=\"e.g. 499\"\n                />\n              </div>\n\n              <div className=\"alert alert-warning mb-0\">\n                <div className=\"fw-semibold\">How it works</div>\n                <div className=\"small\">\n                  Publishers pay subscription (3/6/9 months).  \n                  If they also want <b>Service Listing</b>, it’s an extra fee charged yearly.\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Save footer for small screens */}\n          <div className=\"col-12 d-lg-none\">\n            <div className=\"d-flex gap-2 justify-content-end\">\n              <button\n                className=\"btn btn-light border\"\n                onClick={onReset}\n                disabled={!changed || loading || saving}\n              >\n                Reset\n              </button>\n              <button\n                className=\"btn btn-success\"\n                onClick={onSave}\n                disabled={loading || saving || !changed}\n              >\n                {saving ? \"Saving…\" : \"Save Changes\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
        }
    ]
}