{
    "sourceFile": "src/pages/admin/AllListings.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1766939782166,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1766939782166,
            "name": "Commit-0",
            "content": "import { useEffect, useMemo, useState } from \"react\";\nimport { toast } from \"react-toastify\";\n\nimport {\n  getAdminListings,\n  getAdminListingById,\n  approveAdminListing,\n  rejectAdminListing,\n} from \"../../api/adminListings\";\n\nimport Pagination from \"../../components/Pagination\";\nimport ListingReviewModal from \"../../components/ListingReviewModal\";\n\nexport default function AllListings() {\n  const [loading, setLoading] = useState(true);\n  const [rows, setRows] = useState([]);\n  const [meta, setMeta] = useState({ page: 1, totalPages: 1, limit: 20, total: 0 });\n\n  // Tabs\n  const [tab, setTab] = useState(\"all\"); // all | pending | approved | rejected\n\n  // Filters\n  const [q, setQ] = useState(\"\");\n  const [from, setFrom] = useState(\"\");\n  const [to, setTo] = useState(\"\");\n  const [sort, setSort] = useState(\"new\");\n  const [limit, setLimit] = useState(20);\n  const [page, setPage] = useState(1);\n\n  // Modal\n  const [open, setOpen] = useState(false);\n  const [selectedId, setSelectedId] = useState(null);\n  const [detailLoading, setDetailLoading] = useState(false);\n  const [detail, setDetail] = useState(null);\n  const [actionLoading, setActionLoading] = useState(false);\n\n  const statusParam = useMemo(() => {\n    if (tab === \"all\") return undefined;\n    return tab;\n  }, [tab]);\n\n  const load = async () => {\n    try {\n      setLoading(true);\n\n      const res = await getAdminListings({\n        status: statusParam,\n        q: q || undefined,\n        from: from || undefined,\n        to: to || undefined,\n        sort,\n        page,\n        limit,\n      });\n\n      setRows(res.data?.listings || []);\n      setMeta(res.data?.meta || { page, totalPages: 1, limit, total: 0 });\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to load listings\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    load();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [tab, page, limit, sort]);\n\n  const applyFilters = () => {\n    setPage(1);\n    load();\n  };\n\n  const resetFilters = () => {\n    setQ(\"\");\n    setFrom(\"\");\n    setTo(\"\");\n    setSort(\"new\");\n    setLimit(20);\n    setPage(1);\n    setTimeout(load, 0);\n  };\n\n  const openReview = async (id) => {\n    setSelectedId(id);\n    setOpen(true);\n    setDetail(null);\n\n    try {\n      setDetailLoading(true);\n      const res = await getAdminListingById(id);\n      setDetail(res.data?.listing || null);\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Failed to load listing detail\");\n    } finally {\n      setDetailLoading(false);\n    }\n  };\n\n  const approve = async () => {\n    if (!selectedId) return;\n\n    try {\n      setActionLoading(true);\n      await approveAdminListing(selectedId);\n      toast.success(\"Approved\");\n      setOpen(false);\n      await load();\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Approve failed\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const reject = async (reason) => {\n    if (!selectedId) return;\n\n    try {\n      setActionLoading(true);\n      await rejectAdminListing(selectedId, reason);\n      toast.success(\"Rejected\");\n      setOpen(false);\n      await load();\n    } catch (err) {\n      toast.error(err?.response?.data?.message || \"Reject failed\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const badgeForStatus = (status) => {\n    if (status === \"pending\") return \"bg-warning text-dark\";\n    if (status === \"approved\") return \"bg-success\";\n    if (status === \"rejected\") return \"bg-danger\";\n    return \"bg-secondary\";\n  };\n\n  return (\n    <div className=\"p-2 p-md-3\">\n      <div className=\"d-flex align-items-center justify-content-between mb-3\">\n        <div>\n          <h3 className=\"fw-bold mb-1\">All Listings</h3>\n          <div className=\"text-muted small\">Browse, filter, approve or reject listings</div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <div className=\"bg-white rounded-4 shadow-sm p-2 mb-3\">\n        <div className=\"nav nav-pills gap-2\">\n          {[\"all\", \"pending\", \"approved\", \"rejected\"].map((s) => (\n            <button\n              key={s}\n              className={`btn ${tab === s ? \"btn-success\" : \"btn-light border\"}`}\n              onClick={() => { setTab(s); setPage(1); }}\n              style={{ borderRadius: 12 }}\n            >\n              {s === \"all\" ? \"All\" : s.charAt(0).toUpperCase() + s.slice(1)}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"bg-white rounded-4 shadow-sm p-3 mb-3\">\n        <div className=\"row g-2 align-items-end\">\n          <div className=\"col-12 col-md-4\">\n            <label className=\"form-label small text-muted\">Search</label>\n            <input\n              className=\"form-control\"\n              placeholder=\"Search title/description…\"\n              value={q}\n              onChange={(e) => setQ(e.target.value)}\n            />\n          </div>\n\n          <div className=\"col-6 col-md-2\">\n            <label className=\"form-label small text-muted\">From</label>\n            <input className=\"form-control\" type=\"date\" value={from} onChange={(e) => setFrom(e.target.value)} />\n          </div>\n\n          <div className=\"col-6 col-md-2\">\n            <label className=\"form-label small text-muted\">To</label>\n            <input className=\"form-control\" type=\"date\" value={to} onChange={(e) => setTo(e.target.value)} />\n          </div>\n\n          <div className=\"col-6 col-md-2\">\n            <label className=\"form-label small text-muted\">Sort</label>\n            <select className=\"form-select\" value={sort} onChange={(e) => setSort(e.target.value)}>\n              <option value=\"new\">Newest</option>\n              <option value=\"old\">Oldest</option>\n            </select>\n          </div>\n\n          <div className=\"col-6 col-md-2\">\n            <label className=\"form-label small text-muted\">Per page</label>\n            <select className=\"form-select\" value={limit} onChange={(e) => setLimit(Number(e.target.value))}>\n              <option value={10}>10</option>\n              <option value={20}>20</option>\n              <option value={50}>50</option>\n            </select>\n          </div>\n\n          <div className=\"col-12 d-flex gap-2 justify-content-end\">\n            <button className=\"btn btn-light border\" onClick={resetFilters}>\n              Reset\n            </button>\n            <button className=\"btn btn-success\" onClick={applyFilters}>\n              <i className=\"bi bi-search me-1\" />\n              Apply\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Table */}\n      <div className=\"bg-white rounded-4 shadow-sm p-0 overflow-hidden\">\n        <div className=\"d-flex justify-content-between align-items-center p-3 border-bottom\">\n          <div className=\"fw-bold\">Results</div>\n          <div className=\"text-muted small\">\n            Total: <span className=\"fw-semibold\">{meta.total || 0}</span>\n          </div>\n        </div>\n\n        <div className=\"table-responsive\">\n          <table className=\"table align-middle mb-0\">\n            <thead className=\"table-light\">\n              <tr>\n                <th style={{ minWidth: 260 }}>Title</th>\n                <th style={{ minWidth: 140 }}>Type</th>\n                <th style={{ minWidth: 120 }}>Status</th>\n                <th style={{ minWidth: 200 }}>Publisher</th>\n                <th style={{ minWidth: 120 }}>Created</th>\n                <th className=\"text-end\" style={{ minWidth: 240 }}>Actions</th>\n              </tr>\n            </thead>\n\n            <tbody>\n              {loading ? (\n                <tr><td colSpan={6} className=\"p-4 text-muted\">Loading…</td></tr>\n              ) : rows.length === 0 ? (\n                <tr><td colSpan={6} className=\"p-4 text-muted\">No listings found.</td></tr>\n              ) : (\n                rows.map((r) => (\n                  <tr key={r._id}>\n                    <td>\n                      <div className=\"fw-semibold\">{r.title}</div>\n                      <div className=\"text-muted small text-truncate\" style={{ maxWidth: 380 }}>\n                        {r.description}\n                      </div>\n                    </td>\n\n                    <td>\n                      <span className=\"badge bg-secondary\">{r?.type?.name || \"—\"}</span>\n                    </td>\n\n                    <td>\n                      <span className={`badge ${badgeForStatus(r.status)}`}>{r.status}</span>\n                    </td>\n\n                    <td>\n                      <div className=\"fw-semibold\">{r?.publisherId?.companyName || \"—\"}</div>\n                      <div className=\"text-muted small\">{r?.publisherId?.userId?.email || \"\"}</div>\n                    </td>\n\n                    <td className=\"text-muted small\">\n                      {r.createdAt ? new Date(r.createdAt).toLocaleDateString() : \"—\"}\n                    </td>\n\n                    <td className=\"text-end\">\n                      <div className=\"d-flex gap-2 justify-content-end\">\n                        <button className=\"btn btn-outline-secondary btn-sm\" onClick={() => openReview(r._id)}>\n                          View\n                        </button>\n\n                        {r.status === \"pending\" && (\n                          <>\n                            <button\n                              className=\"btn btn-success btn-sm\"\n                              onClick={async () => {\n                                if (!window.confirm(\"Approve this listing?\")) return;\n                                try {\n                                  await approveAdminListing(r._id);\n                                  toast.success(\"Approved\");\n                                  load();\n                                } catch (err) {\n                                  toast.error(err?.response?.data?.message || \"Approve failed\");\n                                }\n                              }}\n                            >\n                              Approve\n                            </button>\n\n                            <button\n                              className=\"btn btn-danger btn-sm\"\n                              onClick={() => openReview(r._id)}\n                            >\n                              Reject\n                            </button>\n                          </>\n                        )}\n                      </div>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n\n        <div className=\"p-3 border-top\">\n          <Pagination\n            page={meta.page || page}\n            totalPages={meta.totalPages || 1}\n            onPage={(p) => setPage(p)}\n          />\n        </div>\n      </div>\n\n      <ListingReviewModal\n        open={open}\n        onClose={() => setOpen(false)}\n        loading={detailLoading}\n        listing={detail}\n        onApprove={approve}\n        onReject={reject}\n        actionLoading={actionLoading}\n      />\n    </div>\n  );\n}\n"
        }
    ]
}